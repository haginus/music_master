<!doctype html>
<html>
  <head>
    <title>Trap Flexer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" type="text/css"/>
    <script src="{{ url_for('static', filename='scripts.js') }}" type="text/javascript"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <div class="box song-box">
        <h1 class="title">Editează o piesă</h1>
        <form class="page-content">
            <input type="hidden" value="{{song.id}}" id="songId"/>
            <div>
                <div class="input-field">
                    <div class="field-name">Titlu piesă</div>
                    <input type="text" id="songTitle" value="{{song.title}}"/>
                </div>
            </div>
            <div>
                <div class="input-field">
                    <div class="field-name">Artiști piesă</div>
                    <input type="text" id="songArtists" value="{{artists}}"/>
                    <div class="input-help">Separați prin virgule</div>
                </div>
            </div>
            <div>
                <div class="input-field">
                    <div class="field-name">Versuri</div>
                    <textarea rows="20" cols="80" id="songLyrics">{{song.lyrics}}</textarea>
                    <div class="input-help" id="lyricsHelp">Formatat corect</div>
                </div>
            </div>
            <div class="input-field">
                <input type="submit" id="submit" value="Trimite"/>
            </div>
        </form>
        <div id="result"></div>
    </div>
  </body>

<script>
    function edit_song(req) {
        var resultT = document.getElementById('result');
        resultT.textContent = 'Se incarca...';
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                resultT.textContent = 'Gata!';
            }
            console.log(this)
        };
        xhttp.open("POST", "/songs/edit", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(JSON.stringify(req));
    }

    window.onload = function() {
        var submitButton = document.getElementById('submit');
        submitButton.addEventListener("click", function(event) {
            event.preventDefault();
            var id = document.getElementById('songId').value
            var title = document.getElementById('songTitle').value
            var artists = document.getElementById('songArtists').value.split(', ')
            var lyrics = document.getElementById('songLyrics').value
            edit_song({'id': id, 'title': title, 'artists': artists, 'lyrics': lyrics});
        });
        var input = document.getElementById('songLyrics')
        var inputHelp = document.getElementById('lyricsHelp')
        console.log(input.value)
        input.addEventListener("keyup", function(event) {
            reg = /^((\[[^\[\]]*\])+\s*)+$/g
            if(input.value.match(reg) != null) {
                inputHelp.textContent = "Formatare corectă"
                inputHelp.style.color = '#757575';
                submitButton.disabled = false;
            } else {
                inputHelp.textContent = "Formatare incorectă!"
                inputHelp.style.color = '#C62828';
                submitButton.disabled = true;
            }
        });
    }
</script>
</html>